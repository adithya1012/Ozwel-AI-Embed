<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ozwell AI Embed - Test Demo</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f8fafc;
            color: #334155;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        .test-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section h3 {
            margin-top: 0;
            color: #0f172a;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .iframe-container {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
            height: 500px;
            margin-top: 20px;
        }
        .iframe-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        .test-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        .btn:hover {
            background: #2563eb;
        }
        .btn.secondary {
            background: #64748b;
        }
        .btn.secondary:hover {
            background: #475569;
        }
        .status-panel {
            background: #f1f5f9;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        .status-item:last-child {
            border-bottom: none;
        }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #10b981;
        }
        .status-indicator.warning {
            background: #f59e0b;
        }
        .status-indicator.error {
            background: #ef4444;
        }
        .test-logs {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            height: 200px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.9);
            padding: 10px 15px;
            border-radius: 8px;
            text-decoration: none;
            color: #3b82f6;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        .back-link:hover {
            background: white;
        }
    </style>
</head>
<body>
    <a href="../../index.html" class="back-link">‚Üê Back to Home</a>
    
    <div class="header">
        <h1>üß™ Ozwell AI Embed - Test Demo</h1>
        <p>Interactive testing environment for the medical AI chatbot</p>
    </div>

    <div class="test-container">
        <div class="test-section">
            <h3>ü§ñ Live Chatbot Test</h3>
            <div class="test-controls">
                <button class="btn" onclick="refreshIframe()">üîÑ Refresh</button>
                <button class="btn secondary" onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
                <button class="btn" onclick="runHealthCheck()">‚ö° Health Check</button>
                <button class="btn secondary" onclick="simulateError()">‚ö†Ô∏è Test Error</button>
                <button class="btn secondary" onclick="clearLLMConfig()">üóëÔ∏è Clear LLM Config</button>
            </div>
            
            <div class="iframe-container">
                <iframe id="chatbotFrame" src="../../src/components/index.html"></iframe>
            </div>
            
            <div class="test-logs" id="testLogs">
                <div>[INFO] Test demo initialized</div>
                <div>[INFO] Loading chatbot iframe...</div>
                <div>[SUCCESS] Iframe loaded successfully</div>
            </div>
        </div>

        <div class="test-section">
            <h3>üìä System Status</h3>
            
            <div class="status-panel">
                <div class="status-item">
                    <span>Chatbot Connection</span>
                    <div class="status-indicator" id="chatbotStatus"></div>
                </div>
                <div class="status-item">
                    <span>MCP Server</span>
                    <div class="status-indicator" id="mcpStatus"></div>
                </div>
                <div class="status-item">
                    <span>LLM Integration</span>
                    <div class="status-indicator warning" id="llmStatus"></div>
                </div>
                <div class="status-item">
                    <span>Medical Data Access</span>
                    <div class="status-indicator" id="dataStatus"></div>
                </div>
            </div>

            <h4>üîß Test Controls</h4>
            <div class="test-controls">
                <button class="btn" onclick="testMedications()">üíä Test Medications</button>
                <button class="btn" onclick="testAllergies()">üö® Test Allergies</button>
                <button class="btn" onclick="testPatientData()">üë§ Test Patient Data</button>
                <button class="btn" onclick="configureLLM()">‚öôÔ∏è Configure LLM</button>
            </div>

            <h4>üéØ Quick Tests</h4>
            <div class="test-controls">
                <button class="btn secondary" onclick="sendTestMessage('What medications can I take for headaches?')">Medication Query</button>
                <button class="btn secondary" onclick="sendTestMessage('I am allergic to penicillin')">Allergy Alert</button>
                <button class="btn secondary" onclick="sendTestMessage('Show my patient information')">Patient Info</button>
            </div>

            <h4>üìà Performance Metrics</h4>
            <div class="status-panel">
                <div class="status-item">
                    <span>Response Time</span>
                    <span id="responseTime">~1.2s</span>
                </div>
                <div class="status-item">
                    <span>Messages Sent</span>
                    <span id="messageCount">0</span>
                </div>
                <div class="status-item">
                    <span>Errors</span>
                    <span id="errorCount">0</span>
                </div>
                <div class="status-item">
                    <span>Uptime</span>
                    <span id="uptime">00:00:00</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let messageCount = 0;
        let errorCount = 0;
        let startTime = Date.now();

        // Update uptime every second
        setInterval(() => {
            const elapsed = Date.now() - startTime;
            const hours = Math.floor(elapsed / 3600000);
            const minutes = Math.floor((elapsed % 3600000) / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            document.getElementById('uptime').textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }, 1000);

        function logMessage(message, type = 'INFO') {
            const logs = document.getElementById('testLogs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${type}] ${timestamp} - ${message}`;
            logs.appendChild(logEntry);
            logs.scrollTop = logs.scrollHeight;
        }

        function refreshIframe() {
            const iframe = document.getElementById('chatbotFrame');
            iframe.src = iframe.src;
            logMessage('Iframe refreshed');
        }

        function clearLogs() {
            document.getElementById('testLogs').innerHTML = '';
            logMessage('Logs cleared');
        }

        function runHealthCheck() {
            logMessage('Running health check...', 'INFO');
            checkSystemStatus();
        }

        function simulateError() {
            logMessage('Simulating error condition...', 'WARNING');
            errorCount++;
            document.getElementById('errorCount').textContent = errorCount;
            setTimeout(() => {
                logMessage('Connection timeout - Retrying...', 'ERROR');
                document.getElementById('llmStatus').className = 'status-indicator error';
            }, 500);
        }

        function checkSystemStatus() {
            // Check iframe connection
            const iframe = document.getElementById('chatbotFrame');
            if (iframe && iframe.contentWindow) {
                document.getElementById('chatbotStatus').className = 'status-indicator';
                logMessage('Chatbot iframe connection: OK', 'SUCCESS');
            } else {
                document.getElementById('chatbotStatus').className = 'status-indicator error';
                logMessage('Chatbot iframe connection: FAILED', 'ERROR');
            }

            // Check MCP Server status
            try {
                iframe.contentWindow.postMessage({ type: 'health-check' }, '*');
                document.getElementById('mcpStatus').className = 'status-indicator';
                logMessage('MCP Server status: OK', 'SUCCESS');
            } catch (error) {
                document.getElementById('mcpStatus').className = 'status-indicator error';
                logMessage('MCP Server status: ERROR', 'ERROR');
            }

            // Check LLM Integration
            checkLLMStatus();

            // Check Medical Data Access
            document.getElementById('dataStatus').className = 'status-indicator';
            logMessage('Medical Data Access: OK', 'SUCCESS');
        }

        function checkLLMStatus() {
            try {
                const iframe = document.getElementById('chatbotFrame');
                if (iframe && iframe.contentWindow) {
                    // Try to access the LLM manager from the iframe
                    iframe.contentWindow.postMessage({ 
                        type: 'check-llm-status' 
                    }, '*');
                    
                    // Set a timeout to update status
                    setTimeout(() => {
                        // For now, check if any LLM provider is configured
                        const hasOpenAIKey = localStorage.getItem('openai_api_key');
                        const hasOzwellKey = localStorage.getItem('ozwell_api_key');
                        
                        if (hasOpenAIKey || hasOzwellKey) {
                            document.getElementById('llmStatus').className = 'status-indicator';
                            logMessage('LLM Integration: Configured and ready', 'SUCCESS');
                        } else {
                            document.getElementById('llmStatus').className = 'status-indicator warning';
                            logMessage('LLM Integration: No API keys configured', 'WARNING');
                        }
                    }, 500);
                }
            } catch (error) {
                document.getElementById('llmStatus').className = 'status-indicator error';
                logMessage('LLM Integration: Connection error', 'ERROR');
            }
        }

        function testMedications() {
            sendTestMessage('Show me available pain medications');
            logMessage('Testing medication queries');
        }

        function testAllergies() {
            sendTestMessage('I have allergies to shellfish and nuts');
            logMessage('Testing allergy management');
        }

        function testPatientData() {
            sendTestMessage('What is my medical history?');
            logMessage('Testing patient data access');
        }

        function configureLLM() {
            const provider = prompt('Choose LLM provider (openai/ozwell):');
            if (!provider) return;
            
            if (provider.toLowerCase() === 'openai') {
                const apiKey = prompt('Enter OpenAI API Key (or "demo" for demo mode):');
                if (apiKey) {
                    localStorage.setItem('openai_api_key', apiKey === 'demo' ? 'demo-key-12345' : apiKey);
                    localStorage.setItem('openai_model', 'gpt-3.5-turbo');
                    localStorage.setItem('current_llm_provider', 'openai');
                    logMessage('OpenAI configuration saved', 'SUCCESS');
                    setTimeout(checkSystemStatus, 500);
                }
            } else if (provider.toLowerCase() === 'ozwell') {
                const apiKey = prompt('Enter Ozwell API Key (or "demo" for demo mode):');
                if (apiKey) {
                    localStorage.setItem('ozwell_api_key', apiKey === 'demo' ? 'ozwell-demo-key-67890' : apiKey);
                    localStorage.setItem('ozwell_model', 'ozwell-medical-v1');
                    localStorage.setItem('current_llm_provider', 'ozwell');
                    logMessage('Ozwell configuration saved', 'SUCCESS');
                    setTimeout(checkSystemStatus, 500);
                }
            } else {
                logMessage('Invalid provider selected', 'ERROR');
            }
        }

        function clearLLMConfig() {
            localStorage.removeItem('openai_api_key');
            localStorage.removeItem('openai_model');
            localStorage.removeItem('ozwell_api_key');
            localStorage.removeItem('ozwell_model');
            localStorage.removeItem('current_llm_provider');
            logMessage('LLM configuration cleared', 'INFO');
            setTimeout(checkSystemStatus, 500);
        }

        function sendTestMessage(message) {
            messageCount++;
            document.getElementById('messageCount').textContent = messageCount;
            logMessage(`Sending test message: "${message}"`, 'TEST');
            
            // Simulate response time
            const startTime = Date.now();
            setTimeout(() => {
                const responseTime = ((Date.now() - startTime) / 1000).toFixed(1);
                document.getElementById('responseTime').textContent = `~${responseTime}s`;
                logMessage(`Response received in ${responseTime}s`, 'SUCCESS');
            }, Math.random() * 2000 + 500);
        }

        // Initialize
        logMessage('Test demo ready for interaction');
        
        // Check initial system status
        setTimeout(() => {
            checkSystemStatus();
        }, 2000);

        // Listen for messages from iframe
        window.addEventListener('message', (event) => {
            if (event.data.type === 'llm-status-response') {
                if (event.data.configured) {
                    document.getElementById('llmStatus').className = 'status-indicator';
                    logMessage(`LLM Integration: ${event.data.provider} configured`, 'SUCCESS');
                } else {
                    document.getElementById('llmStatus').className = 'status-indicator warning';
                    logMessage('LLM Integration: No provider configured', 'WARNING');
                }
            } else if (event.data.type === 'iframe-ready') {
                logMessage('Iframe initialization complete', 'SUCCESS');
                setTimeout(checkSystemStatus, 1000);
            }
        });
    </script>
</body>
</html>
